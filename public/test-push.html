<!DOCTYPE html>
<html>
<head>
  <title>SuChat í‘¸ì‹œ ì•Œë¦¼ ë””ë²„ê·¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    button {
      padding: 15px 25px;
      font-size: 16px;
      margin: 10px 0;
      width: 100%;
      border: none;
      border-radius: 8px;
      background: #0064FF;
      color: white;
      cursor: pointer;
    }
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>ğŸ”” í‘¸ì‹œ ì•Œë¦¼ ë””ë²„ê·¸</h1>
  
  <button onclick="checkEnvironment()">1ï¸âƒ£ í™˜ê²½ í™•ì¸</button>
  <button onclick="checkPermission()">2ï¸âƒ£ ì•Œë¦¼ ê¶Œí•œ í™•ì¸</button>
  <button onclick="testDirectNotification()">3ï¸âƒ£ ì§ì ‘ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
  <button onclick="checkServiceWorker()">4ï¸âƒ£ Service Worker í™•ì¸</button>
  <button onclick="checkPushSubscription()">5ï¸âƒ£ í‘¸ì‹œ êµ¬ë… í™•ì¸</button>
  <button onclick="testServiceWorkerNotification()">6ï¸âƒ£ SW ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
  <button onclick="sendRealPushTest()" style="background: #ff6b6b;">ğŸš€ ì‹¤ì œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡</button>
  <button onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
  <button onclick="goBack()" style="background: #6c757d;">â† ì„¤ì •ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

  <div class="log" id="log"></div>

  <script>
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const className = type;
      logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLogs() {
      document.getElementById('log').innerHTML = '';
      log('ë¡œê·¸ ì´ˆê¸°í™”ë¨', 'info');
    }

    // 1. í™˜ê²½ í™•ì¸
    function checkEnvironment() {
      log('=== í™˜ê²½ í™•ì¸ ===', 'info');
      
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isSafari = /safari/i.test(navigator.userAgent) && !/chrome|chromium|crios|fxios|edgios/.test(navigator.userAgent);
      const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
      
      log(`iOS: ${isIOS}`, isIOS ? 'info' : 'success');
      log(`Safari: ${isSafari}`, 'info');
      log(`Standalone (í™ˆ í™”ë©´ ì•±): ${isStandalone}`, isStandalone ? 'success' : 'error');
      log(`User Agent: ${navigator.userAgent}`, 'info');
      
      if (isIOS && !isStandalone) {
        log('âš ï¸ iOSì—ì„œëŠ” í™ˆ í™”ë©´ì— ì¶”ê°€ í›„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤!', 'error');
      }
      
      if (isIOS) {
        const match = navigator.userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/);
        if (match) {
          const version = `${match[1]}.${match[2]}`;
          log(`iOS ë²„ì „: ${version}`, parseFloat(version) >= 16.4 ? 'success' : 'error');
          if (parseFloat(version) < 16.4) {
            log('âš ï¸ iOS 16.4 ì´ìƒì´ í•„ìš”í•©ë‹ˆë‹¤!', 'error');
          }
        }
      }
    }

    // 2. ì•Œë¦¼ ê¶Œí•œ í™•ì¸
    async function checkPermission() {
      log('=== ì•Œë¦¼ ê¶Œí•œ í™•ì¸ ===', 'info');
      
      if (!('Notification' in window)) {
        log('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
        return;
      }
      
      log(`í˜„ì¬ ê¶Œí•œ: ${Notification.permission}`, 
        Notification.permission === 'granted' ? 'success' : 'error');
      
      if (Notification.permission !== 'granted') {
        log('ê¶Œí•œ ìš”ì²­ ì¤‘...', 'info');
        const permission = await Notification.requestPermission();
        log(`ê¶Œí•œ ê²°ê³¼: ${permission}`, permission === 'granted' ? 'success' : 'error');
      }
    }

    // 3. ì§ì ‘ ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    function testDirectNotification() {
      log('=== ì§ì ‘ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ===', 'info');
      
      if (Notification.permission !== 'granted') {
        log('âŒ ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”', 'error');
        return;
      }
      
      try {
        const notification = new Notification('í…ŒìŠ¤íŠ¸ ì•Œë¦¼', {
          body: 'ì´ ì•Œë¦¼ì´ ë³´ì´ë©´ ì‹œìŠ¤í…œ ì•Œë¦¼ì€ ì •ìƒì…ë‹ˆë‹¤ âœ…',
          icon: '/icons/icon-192x192.png',
          badge: '/icons/icon-192x192.png',
          tag: 'test-direct'
        });
        
        log('âœ… ì§ì ‘ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ! ì•Œë¦¼ì´ ë³´ì´ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”', 'success');
        
        notification.onclick = () => {
          log('ì•Œë¦¼ í´ë¦­ë¨!', 'success');
          notification.close();
        };
      } catch (error) {
        log(`âŒ ì§ì ‘ ì•Œë¦¼ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    // 4. Service Worker í™•ì¸
    async function checkServiceWorker() {
      log('=== Service Worker í™•ì¸ ===', 'info');
      
      if (!('serviceWorker' in navigator)) {
        log('âŒ Service Worker ë¯¸ì§€ì›', 'error');
        return;
      }
      
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          log('âŒ Service Workerê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
          log('ë“±ë¡ ì‹œë„ ì¤‘...', 'info');
          
          const newReg = await navigator.serviceWorker.register('/sw.js');
          log('âœ… Service Worker ë“±ë¡ ì™„ë£Œ', 'success');
          log(`Scope: ${newReg.scope}`, 'info');
          return;
        }
        
        log('âœ… Service Worker ë“±ë¡ë¨', 'success');
        log(`Scope: ${registration.scope}`, 'info');
        log(`ìƒíƒœ: ${registration.active?.state || 'ì—†ìŒ'}`, 
          registration.active?.state === 'activated' ? 'success' : 'error');
        
        // Service Worker ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
        navigator.serviceWorker.addEventListener('message', (event) => {
          log(`SW ë©”ì‹œì§€: ${JSON.stringify(event.data)}`, 'info');
        });
        
      } catch (error) {
        log(`âŒ Service Worker í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    // 5. í‘¸ì‹œ êµ¬ë… í™•ì¸
    async function checkPushSubscription() {
      log('=== í‘¸ì‹œ êµ¬ë… í™•ì¸ ===', 'info');
      
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          log('âŒ Service Workerê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
          return;
        }
        
        const subscription = await registration.pushManager.getSubscription();
        
        if (!subscription) {
          log('âŒ í‘¸ì‹œ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
          log('ì„¤ì • í˜ì´ì§€ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ í™œì„±í™”í•˜ì„¸ìš”', 'info');
          return;
        }
        
        log('âœ… í‘¸ì‹œ êµ¬ë… ìˆìŒ', 'success');
        log(`Endpoint: ${subscription.endpoint.substring(0, 50)}...`, 'info');
        
        const json = subscription.toJSON();
        log(`Keys ìˆìŒ: ${!!json.keys}`, json.keys ? 'success' : 'error');
        
      } catch (error) {
        log(`âŒ í‘¸ì‹œ êµ¬ë… í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    // 6. Service Worker ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    async function testServiceWorkerNotification() {
      log('=== Service Worker ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ===', 'info');
      
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          log('âŒ Service Workerê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
          return;
        }
        
        if (!registration.active) {
          log('âŒ Service Workerê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
          return;
        }
        
        // Service Workerë¥¼ í†µí•œ ì•Œë¦¼ í‘œì‹œ
        await registration.showNotification('SW í…ŒìŠ¤íŠ¸ ì•Œë¦¼', {
          body: 'Service Workerë¥¼ í†µí•œ ì•Œë¦¼ì…ë‹ˆë‹¤ âœ…',
          icon: '/icons/icon-192x192.png',
          badge: '/icons/icon-192x192.png',
          tag: 'test-sw',
          data: { test: true },
          requireInteraction: false
        });
        
        log('âœ… Service Worker ì•Œë¦¼ ì „ì†¡ ì„±ê³µ! ì•Œë¦¼ì´ ë³´ì´ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”', 'success');
        
      } catch (error) {
        log(`âŒ Service Worker ì•Œë¦¼ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // ì‹¤ì œ ë°±ì—”ë“œë¡œ í‘¸ì‹œ ì „ì†¡
    async function sendRealPushTest() {
      log('=== ì‹¤ì œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ===', 'info');
      
      const token = localStorage.getItem('accessToken');
      
      if (!token) {
        log('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        log('ì„¤ì • í˜ì´ì§€ë¡œ ëŒì•„ê°€ì„œ ë¡œê·¸ì¸í•˜ì„¸ìš”', 'info');
        return;
      }
      
      try {
        log('ë°±ì—”ë“œ API í˜¸ì¶œ ì¤‘...', 'info');
        
        // API URL ê°€ì ¸ì˜¤ê¸° (í™˜ê²½ì— ë”°ë¼ ìë™ ê°ì§€)
        const apiUrl = localStorage.getItem('apiUrl') || 
                       (window.location.hostname === 'localhost' ? 'http://localhost:8000' : window.location.origin);
        
        log(`API URL: ${apiUrl}`, 'info');
        
        const response = await fetch(`${apiUrl}/push/test`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        log('âœ… ë°±ì—”ë“œ í‘¸ì‹œ ì „ì†¡ ì„±ê³µ!', 'success');
        log(`Job ID: ${result.jobId}`, 'success');
        log('ğŸ” ì´ì œ Service Worker ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”!', 'info');
        log('Macì´ë©´: Safari ê°œë°œ â†’ iPhone â†’ SuChat', 'info');
        log('ë˜ëŠ” 10ì´ˆ í›„ ì•Œë¦¼ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”', 'info');
        
      } catch (error) {
        log(`âŒ í‘¸ì‹œ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
      }
    }
    
    // ì„¤ì •ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    function goBack() {
      window.location.href = '/settings';
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ìë™ í™˜ê²½ í™•ì¸
    window.addEventListener('load', () => {
      log('=== SuChat í‘¸ì‹œ ì•Œë¦¼ ë””ë²„ê·¸ ì‹œì‘ ===', 'info');
      checkEnvironment();
    });
  </script>
</body>
</html>

